{
  "kind": "build_request",
  "title": "Rollback production deployment to match Version 54 exactly (without data loss)",
  "projectName": "Malabar Partner",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Revert the application codebase and production deployment to match exactly Version 54 (not Version 55/56), ensuring that any new draft build is also based on the Version 54 code snapshot.",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-9"
        ],
        "quotes": [
          "Pls pls get to the exact same deployment of v54"
        ]
      },
      "acceptanceCriteria": [
        "A new draft build is created from the Version 54 code snapshot (no Version 55/56 changes present).",
        "Production deployment is updated so runtime behavior and UI match the Version 54 deployment exactly.",
        "No automated step in the build process silently rebuilds from Version 55/56 after selecting Version 54."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Ensure the rollback to Version 54 preserves existing persisted canister state (orders, user profiles, master designs, karigars, activity logs, design images/mappings) and does not wipe/reset data; if Version 54 requires a schema change, implement a compatible conditional upgrade migration that preserves all existing data.",
      "target": "backend",
      "source": {
        "messageIds": [
          "project_state.json"
        ],
        "quotes": [
          "Ensure the rollback does not wipe or reset existing persisted canister state (orders, profiles, master designs, karigars, activity logs, design images/mappings) unless Version 54 requires an explicit compatible migration to preserve data."
        ]
      },
      "acceptanceCriteria": [
        "After deploying Version 54, existing production data is still present and accessible (no empty lists due to state loss).",
        "If a migration is required, it runs only on upgrade and converts state without dropping fields/records."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Add a user-visible and developer-verifiable build identifier that clearly indicates the deployed app version (e.g., 'v54') in both frontend and backend, so the team can confirm production is running Version 54 after rollback.",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-9"
        ],
        "quotes": [
          "Pls pls get to the exact same deployment of v54"
        ]
      },
      "acceptanceCriteria": [
        "Frontend displays the current app version/build identifier in an existing global UI surface (e.g., AppShell footer/status area) without requiring special permissions.",
        "Backend exposes a query method (or extends an existing health/status method) returning the app version/build identifier.",
        "The displayed/reported version is 'v54' after the rollback deployment is complete."
      ]
    },
    {
      "id": "REQ-4",
      "text": "Fix the rollback/rebuild flow so that draft expiry and caching do not prevent restoring the exact Version 54 deployment (including ensuring client caches/service worker do not keep serving Version 55/56 assets after rollback).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "project_state.json"
        ],
        "quotes": [
          "Rollback attempts are not completing as expected (revert request still results in Draft Version 55 being built).",
          "Draft app expiry is blocking rebuild/rollback flow (\"Your draft app has expired. Do you want to rebuild it?\")."
        ]
      },
      "acceptanceCriteria": [
        "After rollback deployment, a hard refresh is not required to see Version 54 UI/assets; the app updates cleanly for users already on the site.",
        "Service worker cache versioning is updated/handled so stale cached assets from Version 55/56 are not served after rollback.",
        "Rollback/rebuild does not get forced into rebuilding Version 55 due to draft-expiry handling."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single-actor Motoko canister (all logic in backend/main.mo); only add backend/migration.mo changes if required to preserve state on upgrade.",
    "Do not edit files under frontend/src/components/ui or any frontend immutablePaths listed in SYSTEM_CONTEXT; compose them instead.",
    "Use English for any user-facing text."
  ],
  "nonGoals": [
    "Adding new product features unrelated to restoring Version 54.",
    "Changing authentication away from Internet Identity.",
    "Resetting or deleting production canister state as a shortcut to achieve rollback."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}