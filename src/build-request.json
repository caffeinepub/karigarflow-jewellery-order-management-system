{
  "kind": "build_request",
  "title": "Implement PDF order parsing with karigar-section mapping (orders assigned to subsequent karigar name)",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-65",
      "text": "Implement PDF order parsing for Daily Orders so that orders are assigned to the correct karigar based on the PDF’s layout rule: when a karigar/factory name appears in the PDF, all subsequent order rows belong to that karigar until the next karigar/factory name appears.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-6",
          "msg-9"
        ],
        "quotes": [
          "LOOK AT THIS PDF, THATS HOW THE KARIGAR MAPPING SHOULD WORK, EACH ORDER NEEDS TO BE ASSIGNED TO SUBSEQUENT KARIGAR NAME WHICH IS NOT HAPPENING IN YOUR OUTPUT",
          "Yes try again"
        ]
      },
      "acceptanceCriteria": [
        "Uploading a PDF on the Staff/Admin “Ingest Orders” page no longer throws the current \"PDF parsing is not yet implemented\" error.",
        "The PDF parser extracts orders and sets each parsed order’s `karigarName` to the most recently encountered karigar/factory name found earlier in the PDF text (until a new karigar/factory name is encountered).",
        "If a PDF contains multiple karigar/factory sections, orders are correctly grouped/assigned per section (no leakage across sections).",
        "If the parser cannot find any karigar/factory name in the PDF, it still parses orders but sets `karigarName` to an empty string (not \"Unassigned\") and the UI treats them as unmapped/unassigned in the existing unmapped workflow."
      ]
    },
    {
      "id": "REQ-66",
      "text": "Update the ingestion preview/mapping flow so that PDF-derived karigar assignment is preserved and visible in the preview tables, while still supporting master-design mapping for `genericName` and unmapped design-code detection.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-6"
        ],
        "quotes": [
          "EACH ORDER NEEDS TO BE ASSIGNED TO SUBSEQUENT KARIGAR NAME WHICH IS NOT HAPPENING IN YOUR OUTPUT"
        ]
      },
      "acceptanceCriteria": [
        "After selecting a PDF, the ingestion preview tables show the PDF-derived `karigarName` values for the parsed orders.",
        "The existing master-design mapping step still fills `genericName` where a design-code mapping exists, and continues to classify unmapped design codes into the existing “Unmapped Orders” preview section.",
        "The ingestion preview does not overwrite non-empty `karigarName` values produced by the PDF parser with a fallback label like \"Unassigned\"."
      ]
    },
    {
      "id": "REQ-67",
      "text": "Update backend order upload mapping behavior so that when `uploadParsedOrders` receives an order with a non-empty `karigarName`, the backend does not overwrite that karigar assignment with the master-design `karigarName`; it should still use master designs to fill `genericName` when available and keep the order mapped/active behavior consistent.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-6"
        ],
        "quotes": [
          "LOOK AT THIS PDF, THATS HOW THE KARIGAR MAPPING SHOULD WORK, EACH ORDER NEEDS TO BE ASSIGNED TO SUBSEQUENT KARIGAR NAME WHICH IS NOT HAPPENING IN YOUR OUTPUT"
        ]
      },
      "acceptanceCriteria": [
        "For an uploaded order whose `designCode` matches an active master design entry and whose incoming `karigarName` is non-empty, the stored order keeps the incoming `karigarName` and sets `genericName` from the master design entry.",
        "For an uploaded order whose incoming `karigarName` is empty, the backend keeps the current behavior: it assigns `genericName` and `karigarName` from the active master design mapping when present; otherwise it stores the order into the unmapped workflow.",
        "The backend continues to normalize design codes consistently for master-design lookup during upload.",
        "All authorization behavior remains unchanged (only Admin/Staff can upload; role-based reads remain enforced)."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor in `backend/main.mo` (no additional backend services).",
    "Do not modify any frontend files under `frontend/src/components/ui` or other paths listed as immutable in SYSTEM_CONTEXT.",
    "Use English for all user-facing text added or changed."
  ],
  "nonGoals": [
    "Do not implement third-party authentication providers (only Internet Identity is supported).",
    "Do not introduce external databases or Supabase/Postgres changes (not supported in this stack).",
    "Do not redesign unrelated dashboards/exports beyond what is necessary to correctly show the PDF-derived karigar assignment."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}